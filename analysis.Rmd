Topo Analysis
========================================================

```{r, message=FALSE,warning=FALSE}
#----  Load libraries
library(ggplot2)
library(plyr)
library(caret)
library(doMC)
library(yaml)
library(xtable)
library(reshape2)
library(MASS)
library(grid)
library(gridExtra)
library(hash)
library(devtools)
library(knitr)
library(glmnet)
load_all("~/work/code/Rpackages/cytominr")

registerDoMC()
#registerDoSEQ()
```

```{r, eval=TRUE}
rm(list=ls())
cf = '../input/TIALP-B1/summary_alp.yml'
B <- profile.data(cf)
print(xtable(B$data), file="summary_alp_per_cell.tex", size="tiny")
```

```{r, eval=FALSE}
rm(list=ls())
cf = '../input/TIALP-B1/well-summary-profile_mean-median-none-none.yml'
B <- profile.data(cf)
Xmorp <- feats(B)
Xtopo <- factors(B)
names(Xtopo) <- sub('TiALP_Per_Image.Image_Metadata_', '', names(Xtopo))
names(Xtopo) <- sub('Image_Metadata_', '', names(Xtopo))

# Fix meta data issue # HACK!!
meta_csv <- read.csv('../input/Metadatafile TopoChip_TiALP_array1_allunits_pruned_fixedmetaproblem.csv')
fname_f <- data.frame(FileName_Actin_w_array_name = Xtopo$FileName_Actin_w_array_name)
meta_csv_joined <- join(fname_f, meta_csv, type="left")
names(meta_csv_joined) <- sub('Metadata_', '', names(meta_csv_joined))
Xtopo <- meta_csv_joined

rm(list=c("meta_csv_joined", "meta_csv"))
```

```{r Aggregate_across_replicates, eval=FALSE}
Xmorp0 <- Xmorp
Xmorp0$featureidx <- Xtopo$featureidx
Xmorp0 <- ddply(Xmorp0, .(featureidx), numcolwise(median))
Xmorp0 <- Xmorp0[,!(names(Xmorp0) %in% c('featureidx'))]
saveRDS(Xmorp0, file='../input/Xmorp0.rda')
```

```{r cleanup_X, eval=FALSE}
Xmorp0 <- readRDS('../results/alp_prediction/018ce9ee/Xmorp0.rda')

Xmorp0 <- Xmorp0[,-nearZeroVar(Xmorp0)]
Xmorp0 <- Xmorp0[,-findCorrelation(cor(Xmorp0))]

```

```{r prepare_data, eval=FALSE}
pred_var <- c("ALPCytoplasm_Intensity_IntegratedIntensity_ALP4Corr")
exclude_cols <- unique(c(names(Xmorp0)[grep('ALP', names(Xmorp0))],
                         #names(Xmorp0)[grep('Intensity', names(Xmorp0))],
                         pred_var))
y <- Xmorp0[, pred_var]
Xmorp0m <- as.matrix(Xmorp0[, !(names(Xmorp0) %in% exclude_cols)])

```

```{r test_lm, eval=FALSE}

Xms <- scale(Xmorp0m)
m <- lm(y ~ Xms)
coefs <- summary(m)$coefficients
coefs <- coefs[2:NROW(coefs),]
print(xtable(coefs[coefs[,4] < 0.0005,]), file="top_feats_lm.tex", size="tiny")

C1 <- data.frame(t=coefs[,3])
row.names(C1) <- gsub('Xms', '', row.names(coefs))
C2 <- abs(cor(Xms, y))
C3 <- merge(C1, C2, by=0, all=TRUE)
qplot(t, V1, data=C3) + ylab('Abs Correlation Coef.') + xlab('t-value in regression')
ggsave('regression_correlation.pdf')
 
C4 <- abs(C2)
C4 <- as.data.frame(C4[order(C4,decreasing=T),])
names(C4) <- c("Correlation")
head(C4)
print(xtable(subset(C4, Correlation > .35)), file="top_feats_corr.tex", size="tiny")

```

```{r predict_ALP, eval=FALSE}
method = "lm"
#method = "pls"
#method = "lm"
n <- length(y)
v <- sample(n)
pctr <- 0.5
ntr <- ceiling(pctr * n)
tr_vec <- v[1:ntr]
te_vec <- v[(1 + ntr):n]

Xtr <- Xmorp0m[tr_vec, ]
ytr <- y[tr_vec]
Xte <- Xmorp0m[te_vec, ]
yte <- y[te_vec]


registerDoMC() 
#registerDoSEQ() 
#fit_ <- train(matrix(rnorm(1000), nrow=100, ncol=10), rnorm(100), method=method)
fit <- train(Xtr, ytr, method = method, tuneLength = 15, 
             preProc = c("center", "scale"), 
             trControl = trainControl(method = "repeatedcv", number = 5, repeats = 1))


y_out <- predict(fit, Xte)
plot(yte, y_out)
cor(yte, y_out)

coefs <- abs(fit$finalModel$coefficients)
coefs <- sort(coefs[!(names(coefs) %in% c("(Intercept)"))], decreasing=T)
coefs <- coefs[1:21]
coefs_lab <- factor(1:length(coefs), labels=names(coefs))
qplot(coefs_lab,coefs, geom='bar', stat='identity') + coord_flip() + xlab('Features') + ylab('Regression Coef')

```


