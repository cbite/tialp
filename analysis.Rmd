Topo Analysis
========================================================

```{r, message=FALSE,warning=FALSE}
#----  Load libraries
library(ggplot2)
library(plyr)
library(caret)
library(doMC)
library(yaml)
library(xtable)
library(reshape2)
library(MASS)
library(grid)
library(gridExtra)
library(hash)
library(devtools)
library(knitr)
library(glmnet)
load_all("~/work/code/Rpackages/cytominr")

registerDoMC()
#registerDoSEQ()
```

```{r}
rm(list=ls())
#cf = '../input/TIALP-B1/well-summary-profile_mean-median-none-none.yml'
#cf = '../input/TIALP-B1/cell_counts.yml'
cf = '../input/TIALP-B1/feats_from_db.yml'
B <- profile.data(cf)
Xmorp <- feats(B)
Xtopo <- factors(B)
names(Xtopo) <- sub('TiALP_Per_Image.Image_Metadata_', '', names(Xtopo))
names(Xtopo) <- sub('Image_Metadata_', '', names(Xtopo))

xc1 <- c("ArrayNumber",
       "ChipCOL",
       "ChipROW",
       "NUM",
       "Split",
       "colidxbottom",
       "colidxtop",
       "featureidx",
       "imageidxbottom",
       "imageidxtop",
       "internalidx",
       "rowidxbottom",
       "rowidxtop",
       "unitidxbottom",
       "unitidxtop")

xc2 <- c("FCPLOGN0_1",
         "FCPLOGN0_3",
         "FCPN01",
         "FCPN03")

xc3 <- c("FCP",
         "FCPLOG")

xc4 <- c("FileName_DNA_w_array_name",
         "FileName_ALP_w_array_name",
         "FileName_Actin_w_array_name",
         "Image_FileName_DNA",
         "Image_FileName_ALP",
         "Image_FileName_Actin")


#expt <- "baseline"
expt <- "real"

if (expt == "baseline") {
  # Baseline experiment - Predict FCP
  pred_var <- "FCPLOG"
  y <- Xtopo[,pred_var]
  exclude_cols <- c(xc1, xc2, xc3, xc4, pred_var)  
} else {
  # Real experiment - Predict a morphological feature
  pred_var <- "Cells_AreaShape_FormFactor"
  #pred_var <- "Cells_AreaShape_Area"
  #pred_var <- "Image_Count_Cells"
  y <- Xmorp[,pred_var]
  exclude_cols <- c(xc1, xc2, xc4)  
}


# Create design matrix
Xtopom <- as.matrix(Xtopo[,!(names(Xtopo) %in% exclude_cols)])

```

```{r, eval=TRUE}
method = "rlm"
remove_extremes=T

if (remove_extremes) {
  q <- quantile(y, probs = c(.1,.90))
  filt <- (y > q[[1]]) & (y < q[[2]])  
} else {
  filt <- !vector(length=length(y))
}

#registerDoMC()
#registerDoSEQ()
# fit_ <- train(matrix(rnorm(1000), nrow=100, ncol=10), 
#               rnorm(1000), method=method)

fit <- train(Xtopom[filt,],
                y[filt],
                method = method,
                tuneLength = 15,
                preProc = c("center", "scale"),
                trControl = trainControl(method = "repeatedcv", 
                                         number = 5,
                                         repeats = 1))


plot(y[filt], predict(fit, Xtopom[filt,]))


```

```{r, eval=FALSE}
Xtos <- Xtopo[,"FCP"]
q <- quantile(Xtos, c(0.01,0.99))
fcp_class <- (Xtos<q[1])*1 + (Xtos>q[2])*2
filt <- (Xtos<q[1]) |  (Xtos>q[2])

X <- as.matrix(Xmorp[filt,])
X <- X[,-nearZeroVar(X)]
y <- as.factor(fcp_class[filt])

fit <- train(X,y,
             method = 'svmLinear',
             tuneLength = 5,
             preProc = c("center", "scale"),
             trControl = trainControl(method = "repeatedcv", 
                                      number = 5,
                                      repeats = 1))
fit



```
