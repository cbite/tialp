Topo Analysis
========================================================

```{r, message=FALSE,warning=FALSE}
#----  Load libraries
library(ggplot2)
library(plyr)
library(caret)
library(doMC)
library(yaml)
library(xtable)
library(reshape2)
library(MASS)
library(grid)
library(gridExtra)
library(hash)
library(devtools)
library(knitr)
library(glmnet)
library(RMySQL)
library(DBI)

load_all("~/work/code/Rpackages/cytominr")

registerDoMC()
#registerDoSEQ()
```

```{r, eval=FALSE}
rm(list=ls())

con <- dbConnect(MySQL(),user="cpuser", password="cPus3r",
                 dbname="2012_08_20_TopoChipScreening_deBoerLab", host="imgdb02")

rs <- dbSendQuery(con, 'select I.Image_Metadata_ArrayNumber as Array, avg(ALPCytoplasm_Intensity_IntegratedIntensity_ALP4Corr) as meanALP, median(ALPCytoplasm_Intensity_IntegratedIntensity_ALP4Corr) as medALP, stddev(ALPCytoplasm_Intensity_IntegratedIntensity_ALP4Corr) as stdALP, count(*) as ncells from TiALP_Per_Image as I, TiALP_Per_Object as O where I.ImageNumber = O.ImageNumber group by I.Image_Metadata_ArrayNumber')
tbl <- fetch(rs)
print(xtable(tbl), file="summary_alp_per_cell.tex", size="tiny")

rs <- dbSendQuery(con, 'select Image_Metadata_ArrayNumber as Array, count(*) as nimages, sum(Image_Count_Cells) as ncells, sum(Image_Count_Cells) /count(*) as ncells_per_image from TiALP_Per_Image group by Image_Metadata_ArrayNumber')
tbl <- fetch(rs)
print(xtable(tbl), file="summary_alp_per_image.tex", size="tiny")

dbDisconnect(con)


```

```{r, eval=TRUE}
rm(list=ls())
cf = '../input/TIALP-B1/well-summary-profile_mean-median-none-none.yml'
B <- profile.data(cf)
Xmorp <- feats(B)
Xtopo <- factors(B)
names(Xtopo) <- sub('TiALP_Per_Image.Image_Metadata_', '', names(Xtopo))
names(Xtopo) <- sub('Image_Metadata_', '', names(Xtopo))

# Fix meta data issue # HACK!!
meta_csv <- read.csv('../input/Metadatafile TopoChip_TiALP_array1_allunits_pruned_fixedmetaproblem.csv')
fname_f <- data.frame(FileName_Actin_w_array_name = Xtopo$FileName_Actin_w_array_name)
meta_csv_joined <- join(fname_f, meta_csv, type="left")
names(meta_csv_joined) <- sub('Metadata_', '', names(meta_csv_joined))
Xtopo <- meta_csv_joined
saveRDS(Xtopo, file='Xtopo.rda')
saveRDS(Xmorp, file='Xmorp.rda')
rm(list=c("meta_csv_joined", "meta_csv"))
```

```{r Aggregate_across_replicates, eval=FALSE}
Xmorp0 <- Xmorp
Xmorp0$featureidx <- Xtopo$featureidx
Xmorp0 <- ddply(Xmorp0, .(featureidx), numcolwise(median))
featureidx <- Xmorp0$featureidx
Xmorp0 <- Xmorp0[,!(names(Xmorp0) %in% c('featureidx'))]
saveRDS(Xmorp0, file='Xmorp0.rda')
saveRDS(featureidx, file='featureIdx.rda')

```


```{r pick_featureidxs_for_classification, eval=FALSE}
pred_var <- "ALPCytoplasm_Intensity_IntegratedIntensity_ALP4Corr"

Xalp0 <- data.frame(featureidx=Xtopo$featureidx, 
                    alp = Xmorp[,pred_var], 
                    fname=Xtopo$FileName_Actin_w_array_name)
Xalp1 <- ddply(Xalp0, .(featureidx), summarize, mean = mean(alp), sd = sd(alp), n = length(alp), snr = mean(alp)/sd(alp), 
              featureidx=featureidx[1])

g1_low  <- Xalp1$featureidx[((Xalp1$sd*2)<Xalp1$mean) & (Xalp1$mean < 250)]
g1_high <- Xalp1$featureidx[((Xalp1$sd*2)<Xalp1$mean) & (Xalp1$mean > 450)]

u_low  <- (Xalp0$featureidx %in% g1_low)  & (Xalp0$alp < 200)
u_high <- (Xalp0$featureidx %in% g1_high) & (Xalp0$alp > 530)

d_low  <- Xmorp[u_low,]
d_high <- Xmorp[u_high,]

y_low  <- rep('l', sum(u_low))
y_high <- rep('h', sum(u_high))

D <- rbind(d_low, d_high)
y <- factor(c(y_low, y_high))
D <- D[,-nearZeroVar(D)]
exclude_cols <- unique(c(names(D)[grep('ALP', names(D))], pred_var))
D <- as.matrix(D[, !(names(D) %in% exclude_cols)])

n <- length(y)
v <- sample(n)
pctr <- 0.5
ntr <- ceiling(pctr * n)
tr_vec <- v[1:ntr]
te_vec <- v[(1 + ntr):n]

Dtr <- D[tr_vec, ]
ytr <- y[tr_vec]
Dte <- D[te_vec, ]
yte <- y[te_vec]


registerDoMC() 
#registerDoSEQ() 
#fit_ <- train(matrix(rnorm(1000), nrow=100, ncol=10), rnorm(100), method=method)
fit <- train(Dtr, ytr, method = 'rf', tuneLength = 5, 
             preProc = c("center", "scale"), 
             trControl = trainControl(method = "repeatedcv", number = 5, repeats = 1))


y_out <- predict(fit, Dte)




```

```{r cleanup_X, eval=FALSE}
Xmorp0 <- readRDS('../results/alp_prediction/e052f898/Xmorp0.rda')
featureIdx <- readRDS('../results/alp_prediction/e052f898/featureIdx.rda')
Xmorp0 <- Xmorp0[,-nearZeroVar(Xmorp0)]
Xmorp0 <- Xmorp0[,-findCorrelation(cor(Xmorp0))]

```

```{r test_correlations, eval=FALSE}
rm(list=ls())
Xmorp0 <- readRDS('../results/alp_prediction/018ce9ee/Xmorp0.rda')

categ <- function(v) {
  v <- as.character(v)
  comp <- simplify2array(strsplit(v,"_")[[1]][1])
  type <- simplify2array(strsplit(v,"_")[[1]][2])
  if (type=='RadialDistribution') type <- 'RadDir'
  if (type=='Correlation') type <- 'Corr'
  if (type=='Granularity') type <- 'Gran'
  clist <- c('ALP4Corr', 'Actin4Corr', 'DNA4Corr')
  channel <- clist[unlist(lapply(clist, function(t) length(grep(t, v)) != 0))]
  if (length(channel)!=1) channel <- "None"
  data.frame(feature=v,comp,type,channel)
}

x <- Xmorp0
x <- x[,-nearZeroVar(x)]
x <- as.matrix(x)
x <- cor(x)
x <- as.array(x)
x[upper.tri(x,diag=T)] <- 0
x <- melt(x)
x <- x[abs(x$value) > 0.9,]
x <- x[x$value != 1,]
categs <- ldply(names(Xmorp0), categ)
c1 <- c2<- categs
names(c1) <- paste("f1", names(c1), sep="_")
names(c2) <- paste("f2", names(c2), sep="_")
xm <- x
xm <-  merge(c1, xm, by.x="f1_feature", by.y="X1")
xm <-  merge(c2, xm, by.x="f2_feature", by.y="X2")
xm0 <- merge(c1,c2, all=T)

table(xm$f1_comp,xm$f2_comp)

```

```{r prepare_data, eval=FALSE}
pred_var <- c("ALPCytoplasm_Intensity_IntegratedIntensity_ALP4Corr")
exclude_cols <- unique(c(names(Xmorp0)[grep('ALP', names(Xmorp0))],
                         #names(Xmorp0)[grep('Intensity', names(Xmorp0))],
                         pred_var))
y <- Xmorp0[, pred_var]
Xmorp0m <- as.matrix(Xmorp0[, !(names(Xmorp0) %in% exclude_cols)])

```

```{r test_lm, eval=FALSE}

Xms <- scale(Xmorp0m)
m <- lm(y ~ Xms)
coefs <- summary(m)$coefficients
coefs <- coefs[2:NROW(coefs),]
print(xtable(coefs[coefs[,4] < 0.0005,]), file="top_feats_lm.tex", size="tiny")

C1 <- data.frame(t=coefs[,3])
row.names(C1) <- gsub('Xms', '', row.names(coefs))
C2 <- abs(cor(Xms, y))
C3 <- merge(C1, C2, by=0, all=TRUE)
qplot(t, V1, data=C3) + ylab('Abs Correlation Coef.') + xlab('t-value in regression')
ggsave('regression_correlation.pdf')
 
C4 <- abs(C2)
C4 <- as.data.frame(C4[order(C4,decreasing=T),])
names(C4) <- c("Correlation")
head(C4)
print(xtable(subset(C4, Correlation > .35)), file="top_feats_corr.tex", size="tiny")

```

```{r predict_ALP, eval=FALSE}
method = "lm"
#method = "pls"
#method = "lm"
n <- length(y)
v <- sample(n)
pctr <- 0.5
ntr <- ceiling(pctr * n)
tr_vec <- v[1:ntr]
te_vec <- v[(1 + ntr):n]

Xtr <- Xmorp0m[tr_vec, ]
ytr <- y[tr_vec]
Xte <- Xmorp0m[te_vec, ]
yte <- y[te_vec]


registerDoMC() 
#registerDoSEQ() 
#fit_ <- train(matrix(rnorm(1000), nrow=100, ncol=10), rnorm(100), method=method)
fit <- train(Xtr, ytr, method = method, tuneLength = 15, 
             preProc = c("center", "scale"), 
             trControl = trainControl(method = "repeatedcv", number = 5, repeats = 1))


y_out <- predict(fit, Xte)
plot(yte, y_out)
cor(yte, y_out)

coefs <- abs(fit$finalModel$coefficients)
coefs <- sort(coefs[!(names(coefs) %in% c("(Intercept)"))], decreasing=T)
coefs <- coefs[1:21]
coefs_lab <- factor(1:length(coefs), labels=names(coefs))
qplot(coefs_lab,coefs, geom='bar', stat='identity') + coord_flip() + xlab('Features') + ylab('Regression Coef')

```
